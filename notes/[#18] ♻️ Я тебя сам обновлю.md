# Refreshable materialized view

![clickhouse-notes-refreshable-mv.png](../img/clickhouse-notes-refreshable-mv.png)
.
üí£ –ß—Ç–æ –µ—â–µ –∑–∞ Refreshable MV ? 

–†–∞–Ω–µ–µ –±—ã–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã materialized view:
- [MV 1](https://t.me/double_data/124)
- [MV 2](https://t.me/double_data/128)

`Clickhouse MV` - –∞–Ω–∞–ª–æ–≥ –∏–∑ –º–∏—Ä–∞ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö –°–£–ë–î - —Ç—Ä–∏–≥–≥–µ—Ä—ã, –Ω–µ–∫–∏–π –∫–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –≤—Å—Ç–∞–≤–∫–∏ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É. –û–±—ã—á–Ω–æ MV –≤—ã–ø–æ–ª–Ω—è–µ—é—Ç —Ä–æ–ª—å
–ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ processing –¥–∞–Ω–Ω—ã—Ö (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä –∏–∑ JSON -> FLAT) –∏ –¥—Ä) —Å–æ –≤—Å—Ç–∞–≤–∫–æ–π –≤ —Ü–µ–ª–µ–≤—É—é —Ç–∞–±–ª–∏—Ü—É.

–ù–∞—á–∏–Ω–∞—è —Å –≤–µ—Ä—Å–∏–∏ Clickhouse 23.12 —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª MV —Ä–∞—Å—à–∏—Ä–∏–ª–∏ (—Å–∫–æ—Ä–µ–µ –Ω–µ —Ä–∞—Å—à–∏—Ä–∏–ª–∏, –∞ –ø–æ–¥–≤–µ–∑–ª–∏ –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª üöÄ):
- `Refreshable materialized view (RMV)` - —ç—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ –º–∏—Ä–∞ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö —Å—É–±–¥, –Ω–æ —Å –ø—Ä–∏—Å—É—â–µ–π Clickhouse –∏–∑—é–º–∏–Ω–∫–æ–π `refreshable` -> —É –Ω–∏—Ö –µ—Å—Ç—å cron, 
—Ç–æ –µ—Å—Ç—å –æ–Ω–∏ –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é - –∏ —ç—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

–ó–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ –≤ [–¥–æ–∫—É](https://clickhouse.com/docs/materialized-view/refreshable-materialized-view) üßê
.
–î–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è MV —É –Ω–∞—Å –±—ã–ª pipeline (–ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–∞–º –≤—ã—à–µ), –∫—Ä–∞—Ç–∫–æ:
- python –∫–æ–¥ –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–ª –∑–∞–ø—Ä–æ—Å –≤ Clickhouse, —Å–∞–º python –∫–æ–¥ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç Airflow (–ø–æ–¥–æ—à–µ–ª –±—ã –∏ cron)

–ë—Ä—é–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è, –±—Ä—é–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è....:

```sql
CREATE MATERIALIZED VIEW cdc.openweathermap_raw_refreshmv
REFRESH EVERY 1 minute APPEND -- –º–∞–≥–∏—è –∑–¥–µ—Å—å üßô‚Äç‚ôÄÔ∏è
TO cdc.openweathermap_raw -- –ø—Ä–∏–µ–º–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π
AS
SELECT record_timestamp,
	   record_value
FROM (
SELECT toDateTime(now(), 'Europe/Moscow') AS record_timestamp, *
FROM url('https://api.openweathermap.org/data/2.5/weather?lat=%(lat)s&lon=%(lon)s&appid=%(appid)s&units=metric',
	JSONAsString, 'record_value String')
);
```

–ü–∞–π–ø–ª–∞–Ω —Å—Ç–∞–ª –ø—Ä–æ—â–µ (–≤—ã–∫–∏–Ω—É–ª–∏ —à–µ–¥—É–ª–µ—Ä Airflow –∏–ª–∏ cron, –Ω–µ –≤—ã–∫–∏–Ω—É–ª–∏, –∫–æ–Ω–µ—á–Ω–æ, –∞ –µ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–æ—Å—å –≤–Ω—É—Ç—Ä—å Clickhouse): 
RMV –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (`EVERY 1 minute`) –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ü–µ–ª–µ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `APPEND`.

–ò–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:
- –∑–∞–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`EVERY X <interval>`)
- –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã-–ø—Ä–∏–µ–º–Ω–∏–∫–∞ –Ω–µ–ª—å–∑—è
- `APPEND` \ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è - –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ

–ò–Ω—Ç–µ—Ä–µ—Å–µ–Ω –≤—Ç–æ—Ä–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö), —Å–æ–∑–¥–∞–µ–º RMV (–±–µ–∑ `APPEND`) –∏ —Ç–∞–±–ª–∏—Ü—É-–ø—Ä–∏–µ–º–Ω–∏–∫ —Å `_v2` (cdc.openweathermap_raw_refreshmv_v2, cdc.openweathermap_raw_v2)
–∏ –ª–µ–∑–µ–º –≤ –ª–æ–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ `system.query_log`:

```sql
select type
	, event_date
	, event_time
	, query
	, tables
	, query_kind
	, ql.used_privileges 
from system.query_log ql 
where event_date >= today()
and hasAny(['cdc.openweathermap_raw_refreshmv_v2'], tables)
and type = 'QueryFinish'
order by event_time desc
limit 1
```

–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ:
- –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–π –∑–∞–ø—Ä–æ—Å:
```sql
INSERT INTO cdc.`.tmp.inner_id.26366163-063f-4761-a990-ce80bd4253cf`
...
```

–ê–≥–∞, Clickhouse –≤—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –Ω–æ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–∞–¥–∞—é—Ç –≤ —Ü–µ–ª–µ–≤—É—é ??

- —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ—è—Å–Ω—è–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º

```
SELECT, DROP TABLE ON cdc._tmp_replace_f572fcd715528ac1_vyyrigbhb769007a
INSERT, CREATE TABLE ON cdc.`.tmp.inner_id.26366163-063f-4761-a990-ce80bd4253cf`
SELECT, INSERT, CREATE TABLE, DROP TABLE ON cdc.*
TABLE ENGINE ON MergeTree
CREATE TEMPORARY TABLE ON *.*
INSERT(record_timestamp, record_value) ON cdc.`.tmp.inner_id.26366163-063f-4761-a990-ce80bd4253cf`
```

–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ üôÉ, –Ω–∞ —ç—Ç–æ–º –∫–æ–ø–∞–Ω–∏–µ –ø–æ–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏–º, –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
- –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
- –≤—Å—Ç–∞–≤–∫–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
- replace –¥–∞–Ω–Ω—ã—Ö –≤ —Ü–µ–ª–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ

–î–ª—è –ª—é–±–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

```sql
SYSTEM REFRESH VIEW <rmv_name>;
```

----------------------------------------------

–ù—É –∫–∞–∫ –º–Ω–µ –≤—Å—ë —ç—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å üñ•

–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ RMV —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `system.view_refreshes`, –¥–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:
- –∫–∞–∫–∏–µ RMV –µ—Å—Ç—å
- –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π —Ä–µ—Ñ—Ä–µ—à
- —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ—Ñ—Ä–µ—à
- –æ—à–∏–±–∫–∏
- –∏ –¥—Ä.

–û—à–∏–±–∫–∏ –≤—Å–µ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ:
- —É–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É-–ø—Ä–∏–µ–º–Ω–∏–∫ _v2
- –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–µ—Ñ—Ä–µ—à–∏–º `cdc.openweathermap_raw_refreshmv_v2`
- —Å–º–æ—Ç—Ä–∏–º –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
SELECT exception
FROM system.view_refreshes
where view = 'openweathermap_raw_refreshmv_v2';

-- Code: 390. DB::Exception: Table `openweathermap_raw_v2` doesn't exist.
```

–ë–∏–Ω–≥–æ üòé.

–í–æ—Ç —Ç–∞–∫–æ–π –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Clickhouse, —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –æ–∂–∏–¥–∞–µ–º cron –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é ? (–∏ Airflow —É–∂–µ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω üòâ). 
–ü—Ä–∏–∑–Ω–∞–≤–∞–π—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ: MV –∏\–∏–ª–∏ RMV ?

tags:
- #clickhouse
- #refreshable_materialized_view




